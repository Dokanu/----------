# Симметричное внутреннее соединение с условием
- **get_applications_income** (условие по дате)
- **get_courses_after_date** (условие по дате)
- **get_lessons_by_date_range** (условие по дате)
- **get_reviews_by_date_range** (условие по дате)

# Симметричное внутреннее соединение без условия
- **get_all_districts_and_schools**
- **get_car_and_brand**
- **get_car_with_type**

# Левое внешнее соединение
- **get_all_courses_with_enrollments**

# Правое внешнее соединение
- **get_provided_without_course**

# Запрос на запросе по принципу левого соединения
- **get_all_streams_with_groups**

# Итоговый запрос без условия
- **get_course_statistics**
- **get_review_summary**

# Итоговый запрос без условия с итоговыми данными вида: «всего», «в том числе»
- **get_order_counts_rollup**

# Итоговые запросы с условием на данные (по значению, по маске, с использованием индекса, без использования индекса)
- **get_courses_above_price** (по значению)
- **get_students_by_name_mask** (по маске)
- **get_courses_using_index** (с использованием индекса)
- **get_courses_no_index** (без использования индекса)

# Итоговый запрос с условием на группы
- **get_course_counts_by_district**

# Итоговый запрос с условием на данные и на группы
- **get_high_rated_long_courses**

# Запрос на запросе по принципу итогового запроса
- **get_school_course_counts**

# Запрос с использованием объединения
- **get_schools_and_streams**

# Определить количество заявок по каждой автошколе, по каждому району и по городу в целом
- **get_applications_by_school_and_district**

# Определить тройку сотрудников наиболее часто проводящих занятия по вождению (для каждой автошколы)
- **get_top_3_instructors**

# Определить количество заявок и стоимость оплаты по этим заявкам за указанный год для указанной автошколы
- **get_applications_income** (с параметрами p_school_id и p_year)

---

# Симметричное внутреннее соединение с условием
Эти запросы используют внутреннее соединение таблиц с условием фильтрации данных.

- **get_applications_income**: Подсчитывает количество заявок и общую стоимость для каждой автошколы за указанный год.
- **get_courses_after_date**: Возвращает курсы, которые начинаются после указанной даты.
- **get_lessons_by_date_range**: Возвращает уроки, которые проводятся в указанном диапазоне дат.
- **get_reviews_by_date_range**: Возвращает отзывы, оставленные в указанном диапазоне дат.

# Симметричное внутреннее соединение без условия
Эти запросы используют внутреннее соединение таблиц без дополнительных условий фильтрации.

- **get_all_districts_and_schools**: Возвращает список всех школ и районов.
- **get_car_and_brand**: Возвращает список автомобилей и их брендов.
- **get_car_with_type**: Возвращает список автомобилей и их типов.

# Левое внешнее соединение
Этот запрос использует левое внешнее соединение, чтобы включить все записи из левой таблицы и соответствующие записи из правой таблицы.

- **get_all_courses_with_enrollments**: Возвращает все курсы и количество записей на каждый курс.

# Правое внешнее соединение
Этот запрос использует правое внешнее соединение, чтобы включить все записи из правой таблицы и соответствующие записи из левой таблицы.

- **get_provided_without_course**: Возвращает курсы, которые предоставляются без соответствующего курса.

# Запрос на запросе по принципу левого соединения
Этот запрос использует подзапрос, который работает по принципу левого соединения.

- **get_all_streams_with_groups**: Возвращает все потоки и количество групп в каждом потоке.

# Итоговый запрос без условия
Эти запросы возвращают итоговые данные без каких-либо условий фильтрации.

- **get_course_statistics**: Возвращает общую статистику по курсам.
- **get_review_summary**: Возвращает общую статистику по отзывам.

# Итоговый запрос без условия с итоговыми данными вида: «всего», «в том числе»
Этот запрос возвращает итоговые данные с дополнительными итоговыми строками.

- **get_order_counts_rollup**: Возвращает количество заказов по районам и школам с итоговыми строками.

# Итоговые запросы с условием на данные (по значению, по маске, с использованием индекса, без использования индекса)
Эти запросы возвращают итоговые данные с условиями фильтрации.

- **get_courses_above_price**: Возвращает курсы с ценой выше указанного значения.
- **get_students_by_name_mask**: Возвращает студентов, имена которых соответствуют указанной маске.
- **get_courses_using_index**: Возвращает курсы с ценой выше указанного значения, используя индекс.
- **get_courses_no_index**: Возвращает курсы с ценой выше указанного значения, не используя индекс.

# Итоговый запрос с условием на группы
Этот запрос возвращает итоговые данные с условием группировки.

- **get_course_counts_by_district**: Возвращает количество курсов по районам.

# Итоговый запрос с условием на данные и на группы
Этот запрос возвращает итоговые данные с условиями фильтрации и группировки.

- **get_high_rated_long_courses**: Возвращает курсы с высокими оценками и длительной продолжительностью.

# Запрос на запросе по принципу итогового запроса
Этот запрос использует подзапрос, который работает по принципу итогового запроса.

- **get_school_course_counts**: Возвращает количество курсов по школам.

# Запрос с использованием объединения
Этот запрос использует объединение для объединения результатов нескольких запросов.

- **get_schools_and_streams**: Возвращает список школ и потоков.

# Определить количество заявок по каждой автошколе, по каждому району и по городу в целом
Этот запрос возвращает количество заявок по школам и районам.

- **get_applications_by_school_and_district**: Возвращает количество заявок по школам и районам.

# Определить тройку сотрудников наиболее часто проводящих занятия по вождению (для каждой автошколы)
Этот запрос возвращает топ-3 инструкторов по количеству проведенных уроков для каждой автошколы.

- **get_top_3_instructors**: Возвращает топ-3 инструкторов по количеству проведенных уроков для каждой автошколы.

# Определить количество заявок и стоимость оплаты по этим заявкам за указанный год для указанной автошколы
Этот запрос возвращает количество заявок и общую стоимость оплаты по этим заявкам за указанный год для указанной автошколы.

- **get_applications_income**: Возвращает количество заявок и общую стоимость оплаты по этим заявкам за указанный год для указанной автошколы.



get_active_course_details	"CREATE OR REPLACE FUNCTION public.get_active_course_details()
 RETURNS TABLE(course_id integer, start_date date, end_date date)
 LANGUAGE sql
AS $function$
   SELECT ac.course_id, ac.start_date, ac.end_date
     FROM active_courses ac
    WHERE ac.start_date = (
            SELECT MAX(start_date)
              FROM active_courses
             WHERE course_id = ac.course_id
          );
 $function$
"
get_all_courses	"CREATE OR REPLACE FUNCTION public.get_all_courses()
 RETURNS TABLE(course_id integer, duration smallint, price money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        course_id,
        "course_duration_month",
        course_price
    FROM course;
END;
$function$
"
get_all_courses_with_enrollments	"CREATE OR REPLACE FUNCTION public.get_all_courses_with_enrollments()
 RETURNS TABLE(course_id integer, enrollment_count bigint)
 LANGUAGE sql
AS $function$
   SELECT c.course_id, COUNT(e.enrollment_id)
     FROM course c
     LEFT JOIN enrollment e
       ON c.course_id = (
            SELECT sg.course_id
              FROM student_group sg
             WHERE sg.student_group_id = e.student_group_id
          )
    GROUP BY c.course_id;
 $function$
"
get_all_districts_and_schools	"CREATE OR REPLACE FUNCTION public.get_all_districts_and_schools()
 RETURNS TABLE(school_name character varying, district_name character varying)
 LANGUAGE sql
AS $function$
   SELECT ds.driving_school_name AS school_name, d.district_name
   FROM driving_school ds
   JOIN district d ON ds.district_id = d.district_id;
$function$
"
get_all_schools	"CREATE OR REPLACE FUNCTION public.get_all_schools()
 RETURNS TABLE(driving_school_id integer, driving_school_name character varying, driving_school_adress character varying)
 LANGUAGE sql
AS $function$
  SELECT driving_school_id, driving_school_name, driving_school_adress
    FROM driving_school;
$function$
"
get_all_streams_with_groups	"CREATE OR REPLACE FUNCTION public.get_all_streams_with_groups()
 RETURNS TABLE(stream_id integer, group_count bigint)
 LANGUAGE sql
AS $function$
   SELECT s.stream_id, COUNT(sg.student_group_id)
     FROM stream s
     LEFT JOIN student_group sg ON sg.stream_id = s.stream_id
    GROUP BY s.stream_id;
 $function$
"
get_all_students	"CREATE OR REPLACE FUNCTION public.get_all_students()
 RETURNS TABLE(student_id integer, full_name character varying, born_date date, social_status character varying, work_or_studying_place character varying, phone character varying, non_cash boolean)
 LANGUAGE sql
AS $function$
  SELECT student_id, full_name, born_date, social_status,
         work_or_studying_place, phone, non_cash
    FROM student;
$function$
"
get_applications_by_school_and_district	"CREATE OR REPLACE FUNCTION public.get_applications_by_school_and_district()
 RETURNS TABLE(driving_school_name character varying, district_name character varying, applications bigint)
 LANGUAGE sql
AS $function$
   SELECT ds.driving_school_name,
          d.district_name,
          COUNT(e.enrollment_id)
     FROM enrollment e
     JOIN student_group sg ON e.student_group_id = sg.student_group_id
     JOIN course c ON sg.course_id = c.course_id
     JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
     JOIN district d ON ds.district_id = d.district_id
    GROUP BY ds.driving_school_name, d.district_name;
 $function$
"
get_applications_income	"CREATE OR REPLACE FUNCTION public.get_applications_income()
 RETURNS TABLE(driving_school_name character varying, applications bigint, total_income money)
 LANGUAGE sql
AS $function$
   SELECT 
     ds.driving_school_name,
     COUNT(e.enrollment_id) AS applications,
     COALESCE(SUM(c.course_price), 0::money) AS total_income
   FROM driving_school ds
   JOIN course c ON ds.driving_school_id = c.driving_school_id
   JOIN student_group sg ON sg.course_id = c.course_id
   JOIN stream s ON sg.stream_id = s.stream_id
   LEFT JOIN enrollment e ON e.student_group_id = sg.student_group_id
   WHERE EXTRACT(YEAR FROM s.start_stream_date) = 2024
   GROUP BY ds.driving_school_name;
$function$
"
get_applications_income	"CREATE OR REPLACE FUNCTION public.get_applications_income(p_year integer)
 RETURNS TABLE(driving_school_name character varying, applications bigint, total_income money)
 LANGUAGE sql
AS $function$
   SELECT 
     ds.driving_school_name,
     COUNT(e.enrollment_id) AS applications,
     COALESCE(SUM(c.course_price), 0::money) AS total_income
   FROM driving_school ds
   JOIN course c ON ds.driving_school_id = c.driving_school_id
   JOIN student_group sg ON sg.course_id = c.course_id
   JOIN stream s ON sg.stream_id = s.stream_id
   LEFT JOIN enrollment e ON e.student_group_id = sg.student_group_id
   WHERE EXTRACT(YEAR FROM s.start_stream_date) = p_year
   GROUP BY ds.driving_school_name;
$function$
"
get_applications_income	"CREATE OR REPLACE FUNCTION public.get_applications_income(p_school_id integer, p_year integer)
 RETURNS TABLE(applications bigint, total_income money)
 LANGUAGE sql
AS $function$
    WITH school_courses AS (
        SELECT c.course_id
        FROM course c
        WHERE c.driving_school_id = p_school_id
    )
    SELECT 
        COUNT(e.enrollment_id) AS applications,
        COALESCE(SUM(c.course_price), 0::money) AS total_income
    FROM enrollment e
    INNER JOIN student_group sg ON e.student_group_id = sg.student_group_id
    INNER JOIN course c ON sg.course_id = c.course_id
    INNER JOIN stream s ON sg.stream_id = s.stream_id
    WHERE 
        c.driving_school_id = p_school_id AND
        EXTRACT(YEAR FROM s.start_stream_date) = p_year;
$function$
"
get_car_and_brand	"CREATE OR REPLACE FUNCTION public.get_car_and_brand()
 RETURNS TABLE(car_id integer, car_brand character varying)
 LANGUAGE sql
AS $function$
   SELECT c.car_id, cb.car_brand
     FROM car c
     JOIN car_brand cb ON c.brand_id = cb.brand_id;
 $function$
"
get_car_with_type	"CREATE OR REPLACE FUNCTION public.get_car_with_type()
 RETURNS TABLE(car_id integer, car_type_name character varying)
 LANGUAGE sql
AS $function$
  SELECT c.car_id, ct.car_type_name
    FROM car AS c
    INNER JOIN car_type AS ct
      ON c.car_type_id = ct.car_type_id;
$function$
"
get_course_and_school	"CREATE OR REPLACE FUNCTION public.get_course_and_school()
 RETURNS TABLE(course_id integer, driving_school_name character varying)
 LANGUAGE sql
AS $function$
   SELECT c.course_id, ds.driving_school_name
     FROM course c
     JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id;
 $function$
"
get_course_counts_by_district	"CREATE OR REPLACE FUNCTION public.get_course_counts_by_district()
 RETURNS TABLE(district_name character varying, course_count bigint)
 LANGUAGE sql
AS $function$
   SELECT d.district_name, COUNT(c.course_id)
     FROM driving_school ds
     JOIN course c ON ds.driving_school_id = c.driving_school_id
     JOIN district d ON ds.district_id = d.district_id
    GROUP BY d.district_name;
 $function$
"
get_course_statistics	"CREATE OR REPLACE FUNCTION public.get_course_statistics()
 RETURNS TABLE(total_courses bigint, max_price money, min_duration smallint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        COUNT(*),
        MAX(course_price),
        MIN("course_duration_month")
    FROM course;
END;
$function$
"
get_courses_above_price	"CREATE OR REPLACE FUNCTION public.get_courses_above_price()
 RETURNS TABLE(course_id integer, duration smallint, price money, total_cost money)
 LANGUAGE sql
AS $function$
    SELECT 
        c.course_id,
        c.course_duration_month,
        c.course_price,
        c.total_cost
    FROM course c
    WHERE c.course_price > '5000'; -- фиксированный порог
$function$
"
get_courses_above_price	"CREATE OR REPLACE FUNCTION public.get_courses_above_price(threshold money)
 RETURNS TABLE(course_id integer, duration smallint, price money, total_cost money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        c.course_id,
        c."course_duration_month_",
        c.course_price,
        c.total_cost
    FROM course c
    WHERE c.course_price > threshold;
END;
$function$
"
get_courses_after_date	"CREATE OR REPLACE FUNCTION public.get_courses_after_date(input_start_date date)
 RETURNS TABLE(start_date date, end_date date, price money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT pc.start_date, pc.end_date, c.course_price
    FROM provided_course pc
    INNER JOIN course c ON pc.course_id = c.course_id
    WHERE pc.start_date > input_start_date;
END;
$function$
"
get_courses_no_index	"CREATE OR REPLACE FUNCTION public.get_courses_no_index()
 RETURNS TABLE(course_id integer, course_price money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    SET LOCAL enable_indexscan = OFF;
    RETURN QUERY 
        SELECT c.course_id, c.course_price
        FROM course c
        WHERE c.course_price > '10000';  -- можно изменить на любое значение
END;
$function$
"
get_courses_no_index	"CREATE OR REPLACE FUNCTION public.get_courses_no_index(threshold money)
 RETURNS TABLE(course_id integer, course_price money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    SET LOCAL enable_indexscan = OFF;
    RETURN QUERY 
        SELECT course_id, course_price
        FROM course
        WHERE course_price > threshold;
END;
$function$
"
get_courses_using_index	"CREATE OR REPLACE FUNCTION public.get_courses_using_index()
 RETURNS TABLE(course_id integer, course_price money)
 LANGUAGE sql
AS $function$
    SELECT course_id, course_price
    FROM course
    WHERE course_price > '5000';  -- любое фиксированное значение
$function$
"
get_courses_using_index	"CREATE OR REPLACE FUNCTION public.get_courses_using_index(threshold money)
 RETURNS TABLE(course_id integer, course_price money)
 LANGUAGE sql
AS $function$
   /* Предполагается, что на course_price есть индекс */
   SELECT course_id, course_price
     FROM course
    WHERE course_price > threshold;
 $function$
"
get_enrollment_and_group	"CREATE OR REPLACE FUNCTION public.get_enrollment_and_group()
 RETURNS TABLE(enrollment_id integer, student_group_id integer)
 LANGUAGE sql
AS $function$
   SELECT e.enrollment_id, e.student_group_id
     FROM enrollment e
     JOIN student_group sg ON e.student_group_id = sg.student_group_id;
 $function$
"
get_enrollment_group	"CREATE OR REPLACE FUNCTION public.get_enrollment_group()
 RETURNS TABLE(enrollment_id integer, student_group_id integer, course_id integer)
 LANGUAGE sql
AS $function$
  SELECT e.enrollment_id, sg.student_group_id, sg.course_id
    FROM enrollment AS e
    INNER JOIN student_group AS sg
      ON e.student_group_id = sg.student_group_id;
$function$
"
get_high_rated_long_courses	"CREATE OR REPLACE FUNCTION public.get_high_rated_long_courses(min_grade numeric, min_duration smallint)
 RETURNS TABLE(course_id integer, avg_grade numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        r.course_id,
        AVG(r.grade)
    FROM review r
    INNER JOIN course c ON r.course_id = c.course_id
    WHERE c."course_duration_month" >= min_duration
    GROUP BY r.course_id
    HAVING AVG(r.grade) > min_grade;
END;
$function$
"
get_instructors_by_categories	"CREATE OR REPLACE FUNCTION public.get_instructors_by_categories(categories integer[])
 RETURNS TABLE(instructor_name character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT i.instructor_fullname 
    FROM instructor i
    INNER JOIN course c ON i.instructor_id = c.instructor_id 
    WHERE c.driving_category_id = ANY(categories);
END;
$function$
"
get_lesson_course	"CREATE OR REPLACE FUNCTION public.get_lesson_course()
 RETURNS TABLE(lesson_id integer, course_id integer, course_price money)
 LANGUAGE sql
AS $function$
  SELECT l.lesson_id, c.course_id, c.course_price
    FROM lesson AS l
    INNER JOIN course AS c
      ON l.course_id = c.course_id;
$function$
"
get_lessons_by_date_range	"CREATE OR REPLACE FUNCTION public.get_lessons_by_date_range()
 RETURNS TABLE(lesson_id integer, lesson_date date)
 LANGUAGE sql
AS $function$
    SELECT lesson_id, lesson_date
    FROM lesson
    WHERE lesson_date >= current_date - interval '30 days'
    AND lesson_date <= current_date;
$function$
"
get_lessons_by_date_range	"CREATE OR REPLACE FUNCTION public.get_lessons_by_date_range(d1 date, d2 date)
 RETURNS TABLE(lesson_id integer, lesson_date date)
 LANGUAGE sql
AS $function$
   SELECT lesson_id, lesson_date
     FROM lesson
    WHERE lesson_date BETWEEN d1 AND d2;
 $function$
"
get_lessons_for_course	"CREATE OR REPLACE FUNCTION public.get_lessons_for_course()
 RETURNS TABLE(course_id integer, lesson_id integer, lesson_date date, student_id integer, car_id integer)
 LANGUAGE sql
AS $function$
    SELECT l.course_id, l.lesson_id, l.lesson_date, l.student_id, l.car_id
    FROM lesson l
    LIMIT 100;
$function$
"
get_lessons_for_course	"CREATE OR REPLACE FUNCTION public.get_lessons_for_course(p_course_id integer)
 RETURNS TABLE(lesson_id integer, lesson_date date, student_id integer, car_id integer)
 LANGUAGE sql
AS $function$
   SELECT l.lesson_id, l.lesson_date, l.student_id, l.car_id
     FROM lesson l
    WHERE l.course_id = p_course_id;
 $function$
"
get_order_counts_rollup	"CREATE OR REPLACE FUNCTION public.get_order_counts_rollup()
 RETURNS TABLE(district_name character varying, driving_school_name character varying, orders bigint)
 LANGUAGE sql
AS $function$
  SELECT
    d.district_name,
    ds.driving_school_name,
    COUNT(oc.ordered_course_id) AS orders
  FROM ordered_course AS oc
  JOIN provided_course AS pc
    ON oc.provided_course_id = pc.provided_course_id
  JOIN course AS c
    ON pc.course_id = c.course_id
  JOIN driving_school AS ds
    ON c.driving_school_id = ds.driving_school_id
  JOIN district AS d
    ON ds.district_id = d.district_id
 GROUP BY ROLLUP(d.district_name, ds.driving_school_name)
 ORDER BY d.district_name NULLS LAST, ds.driving_school_name NULLS LAST;
$function$
"
get_ownership_types_above_id	"CREATE OR REPLACE FUNCTION public.get_ownership_types_above_id(min_id integer)
 RETURNS TABLE(type_name character varying, type_count bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT ownership_type_name, COUNT(*) 
    FROM ownership_type
    WHERE ownership_type_id > min_id
    GROUP BY ownership_type_name;
END;
$function$
"
get_provided_without_course	"CREATE OR REPLACE FUNCTION public.get_provided_without_course()
 RETURNS TABLE(provided_course_id integer, course_id integer, driving_category_id integer)
 LANGUAGE sql
AS $function$
  SELECT p.provided_course_id, p.course_id, c.driving_category_id
    FROM course AS c
    RIGHT JOIN provided_course AS p
      ON p.course_id = c.course_id;
$function$
"
get_review_summary	"CREATE OR REPLACE FUNCTION public.get_review_summary()
 RETURNS TABLE(total_reviews bigint, positive_reviews bigint)
 LANGUAGE sql
AS $function$
   SELECT
     COUNT(*),
     SUM(CASE WHEN grade >= 4.0 THEN 1 ELSE 0 END)
     FROM review;
 $function$
"
get_reviews_by_date_range	"CREATE OR REPLACE FUNCTION public.get_reviews_by_date_range()
 RETURNS TABLE(review_id integer, grade numeric, review_date date)
 LANGUAGE sql
AS $function$
    SELECT review_id, grade, review_date
    FROM review
    WHERE review_date >= current_date - interval '90 days'
    AND review_date <= current_date;
$function$
"
get_reviews_by_date_range	"CREATE OR REPLACE FUNCTION public.get_reviews_by_date_range(d1 date, d2 date)
 RETURNS TABLE(review_id integer, grade numeric, review_date date)
 LANGUAGE sql
AS $function$
   SELECT review_id, grade, review_date
     FROM review
    WHERE review_date BETWEEN d1 AND d2;
 $function$
"
get_school_course_counts	"CREATE OR REPLACE FUNCTION public.get_school_course_counts()
 RETURNS TABLE(driving_school_name character varying, course_count bigint)
 LANGUAGE sql
AS $function$
  WITH course_counts AS (
    SELECT driving_school_id, COUNT(*) AS cnt
      FROM course
     GROUP BY driving_school_id
  )
  SELECT ds.driving_school_name, COALESCE(cc.cnt,0)
    FROM driving_school AS ds
    LEFT JOIN course_counts AS cc
      ON ds.driving_school_id = cc.driving_school_id;
$function$
"
get_school_course_stats	"CREATE OR REPLACE FUNCTION public.get_school_course_stats()
 RETURNS TABLE(school_name character varying, course_count bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT ds.driving_school_name, COUNT(c.course_id) 
    FROM driving_school ds
    LEFT JOIN course c ON ds.driving_school_id = c.driving_school_id 
    GROUP BY ds.driving_school_name;
END;
$function$
"
get_school_year_stats	"CREATE OR REPLACE FUNCTION public.get_school_year_stats()
 RETURNS TABLE(driving_school_name character varying, applications bigint, total_income money)
 LANGUAGE sql
AS $function$
   SELECT 
     ds.driving_school_name,
     COUNT(e.enrollment_id) AS applications,
     SUM(c.course_price) AS total_income
   FROM enrollment e
   INNER JOIN student_group sg ON e.student_group_id = sg.student_group_id
   INNER JOIN course c ON sg.course_id = c.course_id
   INNER JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
   INNER JOIN stream s ON sg.stream_id = s.stream_id
   WHERE EXTRACT(YEAR FROM s.start_stream_date) = 2024
   GROUP BY ds.driving_school_name;
$function$
"
get_school_year_stats	"CREATE OR REPLACE FUNCTION public.get_school_year_stats(p_year integer)
 RETURNS TABLE(driving_school_name character varying, applications bigint, total_income money)
 LANGUAGE sql
AS $function$
   SELECT 
     ds.driving_school_name,
     COUNT(e.enrollment_id) AS applications,
     SUM(c.course_price) AS total_income
   FROM enrollment e
   INNER JOIN student_group sg ON e.student_group_id = sg.student_group_id
   INNER JOIN course c ON sg.course_id = c.course_id
   INNER JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
   INNER JOIN stream s ON sg.stream_id = s.stream_id
   WHERE EXTRACT(YEAR FROM s.start_stream_date) = p_year
   GROUP BY ds.driving_school_name;
$function$
"
get_school_year_stats	"CREATE OR REPLACE FUNCTION public.get_school_year_stats(school_id integer, year integer)
 RETURNS TABLE(applications bigint, total_income money)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        COUNT(e.enrollment_id),
        SUM(c.course_price)
    FROM enrollment e
    INNER JOIN student_group sg ON e.student_group_id = sg.student_group_id
    INNER JOIN course c ON sg.course_id = c.course_id
    INNER JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
    WHERE ds.driving_school_id = school_id 
    AND EXTRACT(YEAR FROM e.enrollment_date) = year;
END;
$function$
"
get_schools_and_streams	"CREATE OR REPLACE FUNCTION public.get_schools_and_streams()
 RETURNS TABLE(name character varying, type character varying)
 LANGUAGE sql
AS $function$
  SELECT driving_school_name AS name, 'school' AS type FROM driving_school
  UNION
  SELECT 'Поток ' || stream_name AS name, 'stream' AS type FROM stream;
$function$
"
get_schools_in_central_district	"CREATE OR REPLACE FUNCTION public.get_schools_in_central_district()
 RETURNS TABLE(school_name character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT driving_school_name 
    FROM driving_school 
    WHERE district_id IN (
        SELECT district_id 
        FROM district 
        WHERE district_name = 'Центральный'
    );
END;
$function$
"
get_student_lessons	"CREATE OR REPLACE FUNCTION public.get_student_lessons()
 RETURNS TABLE(student_name character varying, lesson_date date)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT s.full_name, l.lesson_date 
    FROM student s
    INNER JOIN lesson l ON s.student_id = l.student_id;
END;
$function$
"
get_students_by_name_mask	"CREATE OR REPLACE FUNCTION public.get_students_by_name_mask()
 RETURNS TABLE(student_id integer, full_name character varying)
 LANGUAGE sql
AS $function$
    SELECT student_id, full_name
    FROM student
    WHERE full_name ILIKE '%ов%';  -- Пример маски
$function$
"
get_students_by_name_mask	"CREATE OR REPLACE FUNCTION public.get_students_by_name_mask(pat character varying)
 RETURNS TABLE(student_id integer, full_name character varying)
 LANGUAGE sql
AS $function$
   SELECT student_id, full_name
     FROM student
    WHERE full_name LIKE pat;
 $function$
"
get_students_for_stream	"CREATE OR REPLACE FUNCTION public.get_students_for_stream()
 RETURNS TABLE(stream_id integer, student_id integer, full_name character varying)
 LANGUAGE sql
AS $function$
    SELECT sg.stream_id, s.student_id, s.full_name
    FROM student s
    JOIN enrollment e ON s.student_id = e.student_id
    JOIN student_group sg ON e.student_group_id = sg.student_group_id
    LIMIT 100;
$function$
"
get_students_for_stream	"CREATE OR REPLACE FUNCTION public.get_students_for_stream(p_stream_id integer)
 RETURNS TABLE(student_id integer, full_name character varying)
 LANGUAGE sql
AS $function$
   SELECT s.student_id, s.full_name
     FROM student s
     JOIN enrollment e ON s.student_id = e.student_id
     JOIN student_group sg ON e.student_group_id = sg.student_group_id
    WHERE sg.stream_id = p_stream_id;
 $function$
"
get_top_3_instructors	"CREATE OR REPLACE FUNCTION public.get_top_3_instructors()
 RETURNS TABLE(school_name character varying, instructor_fullname character varying, lessons_count bigint)
 LANGUAGE sql
AS $function$
  WITH instr_stats AS (
    SELECT
      ds.driving_school_name,
      i.instructor_fullname,
      COUNT(l.lesson_id) AS lessons_count,
      RANK() OVER (
        PARTITION BY ds.driving_school_id
        ORDER BY COUNT(l.lesson_id) DESC
      ) AS rk
    FROM instructor AS i
    JOIN course AS c
      ON i.instructor_id = c.instructor_id
    JOIN driving_school AS ds
      ON c.driving_school_id = ds.driving_school_id
    LEFT JOIN lesson AS l
      ON c.course_id = l.course_id
   GROUP BY ds.driving_school_id, i.instructor_id
  )
  SELECT driving_school_name, instructor_fullname, lessons_count
    FROM instr_stats
   WHERE rk <= 3;
$function$
"
get_top_instructors	"CREATE OR REPLACE FUNCTION public.get_top_instructors()
 RETURNS TABLE(school_name character varying, instructor_name character varying, lessons_count bigint)
 LANGUAGE sql
AS $function$
    SELECT ds.driving_school_name, i.instructor_fullname, COUNT(l.lesson_id) AS lessons_count
    FROM instructor i
    JOIN course c ON i.instructor_id = c.instructor_id
    JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
    LEFT JOIN lesson l ON c.course_id = l.course_id
    GROUP BY ds.driving_school_name, i.instructor_fullname
    ORDER BY lessons_count DESC
    LIMIT 10;
$function$
"
get_top_instructors	"CREATE OR REPLACE FUNCTION public.get_top_instructors(top_n integer)
 RETURNS TABLE(school_name character varying, instructor_name character varying, lessons_count bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    WITH InstructorStats AS (
        SELECT 
            ds.driving_school_name,
            i.instructor_fullname,
            COUNT(l.lesson_id) AS lessons_count,
            RANK() OVER (PARTITION BY ds.driving_school_id ORDER BY COUNT(l.lesson_id) DESC) AS rank
        FROM instructor i
        INNER JOIN course c ON i.instructor_id = c.instructor_id
        INNER JOIN driving_school ds ON c.driving_school_id = ds.driving_school_id
        LEFT JOIN lesson l ON c.course_id = l.course_id
        GROUP BY ds.driving_school_id, i.instructor_id
    )
    SELECT driving_school_name, instructor_fullname, lessons_count 
    FROM InstructorStats 
    WHERE rank <= top_n;
END;
$function$
"
get_top_rated_courses	"CREATE OR REPLACE FUNCTION public.get_top_rated_courses(min_grade numeric)
 RETURNS TABLE(course_id integer, avg_grade numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT r.course_id, AVG(r.grade) 
    FROM review r
    GROUP BY r.course_id
    HAVING AVG(r.grade) > min_grade;
END;
$function$
"
get_toyota_cars	"CREATE OR REPLACE FUNCTION public.get_toyota_cars()
 RETURNS TABLE(brand character varying, type character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT c.car_brand, ct.car_type_name 
    FROM car_brand c
    INNER JOIN car_type ct ON c.brand_id = ct.car_type_id 
    WHERE c.car_brand LIKE 'Toyota%';
END;
$function$
"
get_unique_districts	"CREATE OR REPLACE FUNCTION public.get_unique_districts()
 RETURNS TABLE(district_name character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT DISTINCT d.district_name 
    FROM district d
    INNER JOIN driving_school ds ON d.district_id = ds.district_id;
END;
$function$
"